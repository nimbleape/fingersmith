<!DOCTYPE html>
<html>
  <head>
    <title>Bluetooth pairing</title>
<!-- Origin Trial Token, feature = Web Bluetooth, origin = https://pi.pe, expires = 2017-01-24 -->
<meta http-equiv="origin-trial" data-feature="Web Bluetooth" data-expires="2017-01-24" content="At+eFpPi6OI0oH0ycsTr4pwz9b/h0mMjhKIYL6MZtGuItXzc2cQq68CR9FEdAzwyetL+RHXiNuLdSgLcsW4hIA8AAABQeyJvcmlnaW4iOiAiaHR0cHM6Ly9waS5wZTo0NDMiLCAiZmVhdHVyZSI6ICJXZWJCbHVldG9vdGgiLCAiZXhwaXJ5IjogMTQ4NTMyMDM5OX0="/>

      <script src="js/require.js"></script>
      <script src="js/phono.sdp.js"></script>
  </head>


 <body>
 Bluetooth....
 <button onclick="onConnectBtnClick()">Connect</button>
 <div id="values"></div>
 </body>

  <script>
    var serviceUuid = parseInt("0x919E");
function str2ab(str) {
  var buf = new ArrayBuffer(str.length); 
  var bufView = new Uint8Array(buf);
  for (var i=0, strLen=str.length; i<strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}
function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}
function createHexString(value) {
    var result = "";
    var arr = new Uint8Array(value.buffer);
    for (i in arr) {
        var str = arr[i].toString(16);
        str = str.length == 0 ? "00" :
              str.length == 1 ? "0" + str :
              str.length == 2 ? str :
              str.substring(str.length-2, str.length);
        result += str;
    }
    return result.toUpperCase();
}
       function buildValues(vs){
          var val = document.getElementById("values");
          var html = "<table>";
          vs.forEach(value => {
              html += "<tr>";
              html += "<td>"+value.name+"</td>";
              html += "<td>"+value.uuid+"</td>";
              html += "<td>"+((value.write)?"write":"read")+"</td>"; 
              html += "<td id=\"val_"+value.name+"\">"+(value.value?value.value:"&nbsp;")+"</td>";
              html += "</tr>";
          });
          html+= "</table>";
          val.innerHTML=html;
       }

    var values = [
          {uuid:"0xFC0A",name:"status",read:true} ,
          {uuid:"0xFC0B",name:"ssid",value:localStorage.ssid,write:true} ,
          {uuid:"0xFC0C",name:"psk",value:localStorage.psk,write:true},
          {uuid:"0xFC0D",name:"fpa",read:true} ,
          {uuid:"0xFC0E",name:"fpb",read:true} ,
          {uuid:"0xFC0F",name:"nonce",read:true}
    ];
    
      window.onload = function(){
        this.buttonTitle = "Connect";
          this.bluetoothDevice = null;
          buildValues(values);
        };

        function onConnectBtnClick() {
          switch(this.buttonTitle) {
            case "Connect":
              if (this.bluetoothDevice) {
                console.log("Internal: Bluetooth device already exists.");
              }
              // Fall through
            case "Reconnect":
              this.connect();
              break;
            case "Disconnect":
              if (!this.bluetoothDevice && !this.bluetoothDevice.gatt) {
                console.log("Internal: No Bluetooth device or connection exists.");
              }
              this.bluetoothDevice.gatt.disconnect();
              break;
            default:
              console.log("Internal: Wrong buttonTitle state!");
          }
        };

        var onGATTDisconnected=  function() {
          this.buttonTitle = "Reconnect";
        }
        var requestDevice= function() {
          if (this.bluetoothDevice) {
            console.log('Attempting to reconnect...')
            return Promise.resolve(this.bluetoothDevice);
          }

          console.log('Requesting Bluetooth Device...');
          return navigator.bluetooth.requestDevice({
            filters: [
              { name: 'Pipe' },
              {services: [serviceUuid]}
            ],
          }).then(device => {
            this.bluetoothDevice = device;
            console.log('Got Bluetooth Device...');

            device.addEventListener('gattserverdisconnected',
              this.onGATTDisconnected.bind(this));
            return device;
          });
        };
        var connect= function() {
          this.requestDevice().then(device => {
            return device.gatt.connect();
          })
          .then(server => {
            return server.getPrimaryService(serviceUuid);
          })
          .then(service => {
            var sequence = Promise.resolve();
            values.forEach(value => {
               sequence = sequence.then( _ => {
                 return service.getCharacteristic(parseInt(value.uuid));
               }).then(charc => { value.chara = charc; });
            });
           values.forEach(value => {
               if (value.read){
                 sequence = sequence.then( _ => {return value.chara.readValue();})
                 .then(vb => { 
                     value.value = createHexString(vb); 
                     var td = document.getElementById("val_"+value.name);
                     td.innerHTML = value.value;
                 });
               }
               if (value.write){
                  sequence = sequence.then( _ => {
                    return value.chara.writeValue(str2ab(value.value));
                  });
               }
            });
            return sequence;
          })
          .then(_ => {
            console.log("Values "+JSON.stringify(values));
            console.log("Connection fully established - disconnecting.");
            this.bluetoothDevice.gatt.disconnect()
          })
          .catch(err => {
            this.bluetoothDevice = null;
            console.log(err);

          })

        }
 /*
            values.forEach(value => {
                 .then(_ => {console.log("written "+value.name+" = "+value.value
)});
            });
            return sequence;
          })
 */
  </script>


</html>
