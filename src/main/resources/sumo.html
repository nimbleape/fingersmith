<html><head><title>Sumo</title></head>
<style>
.term {
    font-family: courier,fixed,swiss,monospace,sans-serif;
    font-size: 14px;
    color: #f0f0f0;
    background: #000000;
}

.termReverse {
    color: #000000;
    background: #00ff00;
}
#note {
    font-size: 12px;
}
</style>
    <script src="js/require.js"></script>
    <script src="js/jquery-1.8.3.js"></script>
    <script src="js/phono.sdp.js"></script>
    <script src="js/ipseorama.js"></script>
    <script src="js/dc.js"></script>
    <script src="js/term.js"></script>
    <script src="js/adapter.js"></script>

    <script type="text/javascript">
        var myFinger = undefined;
        var ipsed = null;
        var chout;
        var termchan;
        var nonceS;
        var friendList = {};
        var mess ="";
        var imagen =0;
        var img = new Image();
        var when =0;
function arrayBufferToString(buffer){
    var arr = new Uint8Array(buffer);
    var str = String.fromCharCode.apply(String, arr);
    if(/[\u0080-\uffff]/.test(str)){
        throw new Error("this string seems to contain (still encoded) multibytes");
    }
    return str;
}
function stringToArrayBuffer(str){
    if(/[\u0080-\uffff]/.test(str)){
        throw new Error("this needs encoding, like UTF-8");
    }
    var arr = new Uint8Array(str.length);
    for(var i=str.length; i--; )
        arr[i] = str.charCodeAt(i);
    return arr.buffer;
}

        var sha256 = require("js/sha256");
        function setFriend(fing){
            $('#tofinger').val(fing);
        }
        function showFriends(friends){
            var pics = "<ol>";
            friends.forEach(function (fr){
                friendList[fr.finger] = fr;

                pics += "<li><img src='"+fr.tag+"' onclick=\"makedc('"+fr.finger+"');\"></li>";
            });
            pics += "</ol>";
            $('#friendList').html(pics);
        }
        function gotFinger(finger) {
            myFinger = finger;
            $('#myFinger').html(finger);
            ipsed = new IpseDataChannel(finger);
            ipsed.setOnDataChannel(onNewDc);
            Ipseorama.dbListPrint(showFriends);
        }
        function showSpeed(){
            var ticks = Date.now() - when;
            var rate = (1000.0 * imagen) / ticks;
            console.log("rate = "+rate);
        }
        function onDcMessage(evt) {
            mess +=evt.data;
            if (mess.endsWith("}")){
               var jval = JSON.parse(mess);
               mess="";
               var framedata = 'data:image/jpeg;base64,' +jval.frame;
               img.onload = function(){
                   var ctx = document.getElementById('camera').getContext('2d');
                   ctx.drawImage(img, 0, 0);
               }
               img.src=framedata;
               if(jval.framecount) {
                   console.log("framecount "+jval.framecount);
               }
               console.log("got image "+imagen++);
               showSpeed();
	       window.setTimeout( function(){
	          var message = {command: "read"};
                  chout.send(JSON.stringify(message));
               },50);
            }
        }
        function onNewDc(channel) {
            console.log("New DC ")
            channel.onmessage = onDcMessage;
        }
            function onTermMessage(evt) {
                var mess = arrayBufferToString(evt.data);
                term.write(mess);
            }
            function sendLine(value) {
                termchan.send(stringToArrayBuffer(value));
            }

            function maketerm() {
                var channel = ipsed.createDataChannel("term", {});
                //var tick;
                channel.onopen = function() {
                    termchan = channel;
                    termchan.onmessage = onTermMessage;
                    console.log("Terminal channel ");
                    var fl = document.getElementById('terminal');
                    term = new Term(80, 24, sendLine,fl);
                    term.open();
                    sendLine("TERM=vt100 export TERM\r");
                    sendLine("./pilot.sh\r");
                };
            }
        function makedc(tofinger) {
            console.log("setting toFinger" + tofinger);

            ipsed.setTo(tofinger);
            ipsed.setNonce(nonceS);
            var channel = ipsed.createDataChannel("camera", {});
            channel.onopen = function() {
                console.log("Video channel ");
                var message = {command: "read"};
                channel.send(JSON.stringify(message));
                when = Date.now();
                $('#friendList').hide();
                $('#camera').show();
            };
            channel.onmessage = onDcMessage;
            chout = channel;
            maketerm();
        }
        $(document).ready(function() {
            Ipseorama.whoAmI(gotFinger, function(err) {
                console.log("could not create identity " + err);
            });
        });
    </script>
    <h1>remote camera</h1>
    <div> My Fingerprint is :
        <span id="myFinger">unknown</span> </div>
    <div id="friendList">

    </div>

    <h3>Output</h3>
    <div id="terminal"></div>
    <canvas id="camera" width="640" height="360"/>


</body>
</html>
