<html><head><title>Socko Web Socket Example</title></head>
    <script src="/js/jquery-1.8.3.js"></script>
    <script src="/js/phono.sdp.js"></script>
    <script src="/js/ipseorama.js"></script>
    <script src="/js/dc.js"></script>
    <script src="/js/LazarQr.min.js"></script>
    <script src="/js/adapter.js"></script>
    <script src="/js/gauge.min.js"></script>

    <script type="text/javascript">
  var myFinger = undefined;
  var ipsed = null;
  var chout;
  var distance;
  var battery;
  var heading;


  function gotFarFinger(ff){
                    $('#tofinger').val(ff);
                    $("#qr-canvas").remove();
                    $("#gumVideo").css("display","block");
  }

  function gotFinger(finger){
    var farFinger;
    myFinger = finger;
    $('#myFinger').html(finger);
    ipsed = new IpseDataChannel(finger);
    ipsed.setOnDataChannel(onNewDc);
    farFinger = localStorage.getItem("farFinger");
    askforCam();
    if (farFinger){
        gotFarFinger(farFinger);
    }
  }
  function makeGauge(id){
    var opts = {
        lines: 12, // The number of lines to draw
        angle: 0.15, // The length of each line
        lineWidth: 0.44, // The line thickness
        pointer: {
            length: 0.9, // The radius of the inner circle
            strokeWidth: 0.035, // The rotation offset
            color: '#000000' // Fill color
        },
        limitMax: 'true',   // If true, the pointer will not go past the end of the gauge
        colorStart: '#6FADCF',   // Colors
        colorStop: '#8FC0DA',    // just experiment with them
        strokeColor: '#E0E0E0',   // to see which ones work best for you
        generateGradient: true
    };
    var target = document.getElementById(id); // your canvas element
    var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
    gauge.animationSpeed = 32; // set animation speed (32 is default value)
    return gauge;
  }

  function onDcMessage(evt){
      var mess = JSON.parse(evt.data);
      if (mess.stats) {
        var stats = mess.stats;
        console.log(JSON.stringify(stats));
        if (stats.distance > 0){
            $('#distance').html(stats.distance);
            distance.set(stats.distance * 1000);
        }
        $('#voltage').html(stats.voltage);
        $('#heading').html(stats.heading);
        $('#tacho').html(stats.tacho);
        $('#touch').html(stats.touch[0]);

        var r = Math.round( 1096.0 * stats.color[0]);
        var g = Math.round( 1096.0 * stats.color[1]);
        var b = Math.round( 1096.0 * stats.color[2]);
        $('#color').html(" "+r+" "+g+" "+b);
        heading.set(stats.heading * -1);
        battery.set(stats.voltage);
      } else {
        $('#status').html(evt.data);
      }
  }
  function onNewDc(channel){
      console.log("New DC ")
      channel.onmessage = onDcMessage;
  }
  function makedc(){
    var tofinger = $('#tofinger').val();
    console.log("setting toFinger"+tofinger);

    ipsed.setTo(tofinger);
    var channel = ipsed.createDataChannel("test",{});
    channel.onopen = function() {
        // e.g. enable send button
        //enableChat(channel);
        console.log("Outbound channel open");
        $("#remoteVideoContainer").remove();
        chout.send("A");
    };
    channel.onmessage = onDcMessage;
    chout = channel;
  }

  function button(cmd) {
    chout.send(cmd);
  }

            function startQrDecode() {
                var video = document.getElementById('gumVideo');
                var photo = document.getElementById('qr-canvas');
                var context = photo.getContext('2d');
                // set our canvas to the same size as our video

                qrcode.callback = function(code) {
                    console.log("got qrcode of " + code);
                    clearInterval(tick);
                    navigator.vibrate(50);
                    localStorage.setItem('farFinger',code);
                    gotFarFinger(code);
                };
                var tick = setInterval(function() {
                    if ((video.videoWidth > 0) && (video.videoHeight > 0)) {
                        var rat = video.height / video.videoHeight;

                        photo.width = video.videoWidth * rat;
                        photo.height = video.videoHeight * rat;
                        console.log("set video to " + video.width + " x " + video.height);
                        console.log("rat was " + rat);
                        context.drawImage(video, 0, 0, photo.width, photo.height,0,0,photo.width, photo.height);
                        qrcode.decode();
                    }
                }, 250);
            }
            function startGum(sid) {
                var constraints = {video: true, audio: false};
                if (sid) {
                    constraints.video = {optional: [{sourceId: sid}]};
                }
                navigator.getUserMedia(constraints,
                        function(stream) {
                            var url = window.URL || window.webkitURL;
                            var v = document.getElementById('gumVideo');
                            v.src = url ? url.createObjectURL(stream) : stream;
                            v.play();
                            var far = localStorage.getItem("farFinger");
                            if (!far){
                                startQrDecode();
                            }
                        },
                        function(error) {
                            alert('Something went wrong. (error code ' + error.code + ')');
                            location.href = "nogum.htm";
                            return;
                        }
                );
            }
            function onSourcesAcquired(sources) {
                var sid;
                for (var i = 0; i != sources.length; ++i) {
                    var source = sources[i];
                    console.log(source);
                    if ((source.kind == "video") && (source.facing == "environment")) {
                        sid = source.id;
                        //break;
                    }
                    // source.id -> DEVICE ID
                    // source.label -> DEVICE NAME
                    // source.kind = "audio" OR "video"
                    // TODO: add this to some datastructure of yours or a selection dialog
                }
                startGum(sid);
            }
            function askforCam() {
                console.log("starting QR reader");
                //frontcam...
                var sid;
                if ((typeof MediaStreamTrack === 'undefined') || (typeof MediaStreamTrack.getSources == 'undefined')) {
                    startGum(sid);
                } else {
                    MediaStreamTrack.getSources(onSourcesAcquired);
                }
            }
            function getUrlVars()
            {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++)
                {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            }
            $( document ).ready(function() {
              var args = getUrlVars();
              var uff = args['far'];
              if (uff){
                    localStorage.removeItem('farFinger');
              } else {
                    localStorage.setItem('farFinger',uff);
              }

              Ipseorama.whoAmI(gotFinger,function(err) {
                console.log("could not create identity " + err)
                });
              heading = makeGauge("headingG");
              heading.maxValue = 90; heading.minValue = -90;
              battery = makeGauge("batteryG");
              battery.maxValue = 9; battery.minValue = 5;
              distance = makeGauge("distanceG");
              distance.maxValue = 100; distance.minValue = 0;

            });
</script>
<h1>Fingersmith test page</h1>
<div> My Fingerprint is :
<span id="myFinger">unknown</span> </div>
    <div id="remoteVideoContainer" class="ui-video-remote-container">
        <canvas width="480" height="480" id="qr-canvas"></canvas>
        <video style="display:none;" width="480" height="480" id="gumVideo" autoplay="autoplay"/>
    </div>
<div id="gaugeContainer">
    <canvas width="300" height="300" id="batteryG"></canvas>
    <canvas width="300" height="300" id="headingG"></canvas>
    <canvas width="300" height="300" id="distanceG"></canvas>
</div>
<form onsubmit="return false;">
  <input type="text" name="to" id="tofinger" value="Unknown"/>
  <input type="button" value="connect" onclick="makedc();" />
</form>
<div id="caller">
    <ul>
    Distance <li id="distance"></li>
    Voltage <li id="voltage"></li>
    Heading <li id="heading"></li>
    Tacho <li id="tacho"></li>
    Color <li id="color"></li>
    Touch <li id="touch"></li>

    </ul>
    <div id="controls">
        <button id="connectButton" type="button" value="Forward" onClick="button('F')"  >
            Forward&nbsp;
        </button>
        <button  id="hangupButton" type="button" value="Back" onClick="button('B')" >
            Back&nbsp;
        </button>
        <button  id="wakeButton" type="button" value="Left" onClick="button('L')" >
            Left&nbsp;
        </button>
        <button  id="forgetButton" type="button" value="Right" onClick="button('R')" >
            Right&nbsp;
        </button>
    </div>
    <div id="status"></div>
</div>
</body>
</html>
